#!/bin/bash

HOOKS_DIR=$(dirname "$0")

VM_NAME="$1"    # domain name
EVENT="$2"      # start, stopped, etc.
PHASE="$3"      # begin, end, etc.

VM_DIR="$HOOKS_DIR/qemu.d/$VM_NAME"

# If there is no per-VM directory, do nothing
if [ ! -d "$VM_DIR" ]; then
    exit 0
fi

# Before VM starts -> allocate hugepages
if [ "$EVENT" = "start" ] && [ "$PHASE" = "begin" ]; then
    if [ -x "$VM_DIR/allocpages.sh" ]; then
        "$VM_DIR/allocpages.sh" "$@"
    fi
fi

# After VM stops -> remove hugepages
if [ "$EVENT" = "stopped" ] && [ "$PHASE" = "end" ]; then
    if [ -x "$VM_DIR/removepages.sh" ]; then
        "$VM_DIR/removepages.sh" "$@"
    fi
fi
